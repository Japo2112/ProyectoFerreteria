-- =========================================
-- PROYECTO: SISTEMA DE MATERIALES DE CONSTRUCCIÓN
-- AUTOR: Jared Piche (alm33)
-- REVISIÓN: Script corregido con atomicidad y auditoría funcional.
-- =========================================

-- (1) -- ELIMINAR TABLAS PREVIAS (solo para reiniciar en entorno de test)
BEGIN
  FOR t IN (SELECT table_name FROM user_tables WHERE table_name NOT LIKE 'BIN$%') LOOP
    BEGIN
      EXECUTE IMMEDIATE 'DROP TABLE ' || t.table_name || ' CASCADE CONSTRAINTS';
    EXCEPTION WHEN OTHERS THEN NULL;
    END;
  END LOOP;
EXCEPTION
  WHEN OTHERS THEN NULL;
END;
/
-- Nota: en producción NO ejecutar la limpieza automática.

-- =============================
-- TABLAS (CON IDENTITY)

-- =============================
-- (Las tablas estaban perfectas, se dejan idénticas)

CREATE TABLE SUCURSAL (
  id_sucursal      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(100) NOT NULL,
  direccion        VARCHAR2(200),
  region           VARCHAR2(50)
);

CREATE TABLE ROLES_APLICACION (
  rol_app_id       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre_rol       VARCHAR2(50) NOT NULL,
  descripcion      VARCHAR2(200)
);

CREATE TABLE CLIENTE (
  id_cliente       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(150) NOT NULL,
  nit              VARCHAR2(20) UNIQUE,
  direccion        VARCHAR2(200),
  telefono         VARCHAR2(30),
  email            VARCHAR2(100),
  tipo_cliente     VARCHAR2(20) DEFAULT 'Contado' CHECK (tipo_cliente IN ('Contado','Credito')),
  limite_credito   NUMBER(12,2) DEFAULT 0,
  sucursal_id      NUMBER,
  CONSTRAINT fk_cliente_sucursal FOREIGN KEY (sucursal_id) REFERENCES SUCURSAL(id_sucursal)
);

CREATE TABLE VENDEDOR (
  id_vendedor      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(120) NOT NULL,
  area             VARCHAR2(50),
  telefono         VARCHAR2(30),
  email            VARCHAR2(100)
);

CREATE TABLE CATEGORIA (
  id_categoria     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(100) NOT NULL,
  descripcion      VARCHAR2(200)
);

CREATE TABLE PRODUCTO (
  id_producto      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(150) NOT NULL,
  categoria_id     NUMBER,
  precio_unitario  NUMBER(14,2) NOT NULL,
  unidad_medida    VARCHAR2(20),
  estado           VARCHAR2(20) DEFAULT 'Activo' CHECK (estado IN ('Activo','Inactivo')),
  CONSTRAINT fk_producto_categoria FOREIGN KEY (categoria_id) REFERENCES CATEGORIA(id_categoria)
);

CREATE TABLE EXISTENCIAS_SUCURSAL (
  producto_id      NUMBER NOT NULL,
  sucursal_id      NUMBER NOT NULL,
  cantidad_stock   NUMBER(14,2) DEFAULT 0,
  stock_minimo     NUMBER(14,2) DEFAULT 0,
  CONSTRAINT pk_existencias PRIMARY KEY (producto_id, sucursal_id),
  CONSTRAINT fk_existencias_producto FOREIGN KEY (producto_id) REFERENCES PRODUCTO(id_producto),
  CONSTRAINT fk_existencias_sucursal FOREIGN KEY (sucursal_id) REFERENCES SUCURSAL(id_sucursal)
);

CREATE TABLE FORMA_PAGO (
  id_forma_pago    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  tipo             VARCHAR2(40) NOT NULL
);

CREATE TABLE FACTURA (
  id_factura       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  numero_factura   VARCHAR2(30) UNIQUE NOT NULL,
  fecha            DATE DEFAULT SYSDATE,
  cliente_id       NUMBER,
  vendedor_id      NUMBER,
  sucursal_id      NUMBER,
  tipo_pago_id     NUMBER,
  total            NUMBER(14,2) DEFAULT 0,
  saldo_pendiente  NUMBER(14,2) DEFAULT 0,
  estado           VARCHAR2(20) DEFAULT 'Emitida' CHECK (estado IN ('Emitida','Parcial','Pagada','Credito')) ,
  CONSTRAINT fk_factura_cliente FOREIGN KEY (cliente_id) REFERENCES CLIENTE(id_cliente),
  CONSTRAINT fk_factura_vendedor FOREIGN KEY (vendedor_id) REFERENCES VENDEDOR(id_vendedor),
  CONSTRAINT fk_factura_sucursal FOREIGN KEY (sucursal_id) REFERENCES SUCURSAL(id_sucursal),
  CONSTRAINT fk_factura_forma FOREIGN KEY (tipo_pago_id) REFERENCES FORMA_PAGO(id_forma_pago)
);

CREATE TABLE FACTURA_DETALLE (
  id_factura_detalle NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  factura_id         NUMBER NOT NULL,
  producto_id        NUMBER NOT NULL,
  cantidad           NUMBER(14,2) NOT NULL,
  precio_unitario    NUMBER(14,2) NOT NULL,
  subtotal           NUMBER(14,2) NOT NULL,
  sucursal_origen_id NUMBER NOT NULL, 
  CONSTRAINT fk_fd_factura FOREIGN KEY (factura_id) REFERENCES FACTURA(id_factura) ON DELETE CASCADE,
  CONSTRAINT fk_fd_producto FOREIGN KEY (producto_id) REFERENCES PRODUCTO(id_producto),
  CONSTRAINT fk_fd_sucursal_origen FOREIGN KEY (sucursal_origen_id) REFERENCES SUCURSAL(id_sucursal)
);

CREATE TABLE NOTA_CREDITO (
  id_nota_credito  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  factura_id       NUMBER NOT NULL,
  fecha            DATE DEFAULT SYSDATE,
  motivo           VARCHAR2(300),
  total_monto      NUMBER(14,2) DEFAULT 0,
  usuario_id       NUMBER,
  CONSTRAINT fk_nc_factura FOREIGN KEY (factura_id) REFERENCES FACTURA(id_factura)
);

CREATE TABLE NOTA_CREDITO_DETALLE (
  id_nc_detalle    NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nota_id          NUMBER NOT NULL,
  producto_id      NUMBER NOT NULL,
  cantidad_devuelta NUMBER(14,2) NOT NULL,
  precio_devolucion NUMBER(14,2) NOT NULL,
  sucursal_devolucion_id NUMBER NOT NULL, 
  CONSTRAINT fk_ncd_nota FOREIGN KEY (nota_id) REFERENCES NOTA_CREDITO(id_nota_credito) ON DELETE CASCADE,
  CONSTRAINT fk_ncd_producto FOREIGN KEY (producto_id) REFERENCES PRODUCTO(id_producto),
  CONSTRAINT fk_ncd_sucursal FOREIGN KEY (sucursal_devolucion_id) REFERENCES SUCURSAL(id_sucursal)
);

CREATE TABLE PROVEEDOR (
  id_proveedor     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(150) NOT NULL,
  nit              VARCHAR2(30),
  contacto         VARCHAR2(120),
  telefono         VARCHAR2(30),
  email            VARCHAR2(100),
  direccion        VARCHAR2(200)
);

CREATE TABLE COMPRA (
  id_compra        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  proveedor_id     NUMBER,
  fecha            DATE DEFAULT SYSDATE,
  total            NUMBER(14,2) DEFAULT 0,
  saldo_pendiente  NUMBER(14,2) DEFAULT 0,
  estado           VARCHAR2(20) DEFAULT 'Pendiente' CHECK (estado IN ('Pendiente','Parcial','Pagada')) ,
  CONSTRAINT fk_compra_proveedor FOREIGN KEY (proveedor_id) REFERENCES PROVEEDOR(id_proveedor)
);

CREATE TABLE COMPRA_DETALLE (
  id_compra_detalle NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  compra_id         NUMBER NOT NULL,
  producto_id       NUMBER NOT NULL,
  cantidad          NUMBER(14,2) NOT NULL,
  costo_unitario    NUMBER(14,2) NOT NULL,
  sucursal_destino_id NUMBER NOT NULL, 
  CONSTRAINT fk_cd_compra FOREIGN KEY (compra_id) REFERENCES COMPRA(id_compra) ON DELETE CASCADE,
  CONSTRAINT fk_cd_producto FOREIGN KEY (producto_id) REFERENCES PRODUCTO(id_producto),
  CONSTRAINT fk_cd_sucursal_destino FOREIGN KEY (sucursal_destino_id) REFERENCES SUCURSAL(id_sucursal)
);

CREATE TABLE VEHICULO (
  id_vehiculo      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  marca            VARCHAR2(80),
  modelo           VARCHAR2(80),
  placa            VARCHAR2(30),
  tipo_placa       VARCHAR2(30)
);

CREATE TABLE PILOTO (
  id_piloto        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(120),
  licencia         VARCHAR2(80),
  telefono         VARCHAR2(30)
);

CREATE TABLE TRANSPORTE (
  id_envio         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  factura_id       NUMBER,
  vehiculo_id      NUMBER,
  piloto_id        NUMBER,
  fecha_envio      DATE,
  fecha_entrega    DATE,
  estado_envio     VARCHAR2(20) DEFAULT 'Pendiente' CHECK (estado_envio IN ('Pendiente','En Ruta','Entregado')) ,
  descripcion_carga VARCHAR2(300),
  CONSTRAINT fk_transp_factura FOREIGN KEY (factura_id) REFERENCES FACTURA(id_factura),
  CONSTRAINT fk_transp_vehiculo FOREIGN KEY (vehiculo_id) REFERENCES VEHICULO(id_vehiculo),
  CONSTRAINT fk_transp_piloto FOREIGN KEY (piloto_id) REFERENCES PILOTO(id_piloto)
);

CREATE TABLE USUARIO (
  id_usuario       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(120) NOT NULL,
  username         VARCHAR2(80) UNIQUE NOT NULL,
  password_hash    VARCHAR2(300) NOT NULL,
  activo           CHAR(1) DEFAULT 'S' CHECK (activo IN ('S','N')),
  rol_app_id       NUMBER, 
  last_login       TIMESTAMP,
  CONSTRAINT fk_usuario_rol FOREIGN KEY (rol_app_id) REFERENCES ROLES_APLICACION(rol_app_id)
);

CREATE TABLE AUDITORIA_GENERAL (
  id_auditoria     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  usuario_id       NUMBER,
  accion           VARCHAR2(20), 
  tabla_afectada   VARCHAR2(100),
  pk_afectada      VARCHAR2(200),
  fecha_hora       TIMESTAMP DEFAULT SYSTIMESTAMP,
  datos_viejos     CLOB,
  datos_nuevos     CLOB,
  detalle          VARCHAR2(1000),
  CONSTRAINT fk_aud_usuario FOREIGN KEY (usuario_id) REFERENCES USUARIO(id_usuario)
);

CREATE TABLE PAGOS_VENTAS (
  pago_id          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  factura_id       NUMBER NOT NULL,
  monto_pagado     NUMBER(14,2) NOT NULL,
  fecha_pago       DATE DEFAULT SYSDATE,
  medio_pago       VARCHAR2(50),
  referencia       VARCHAR2(100),
  CONSTRAINT fk_pv_factura FOREIGN KEY (factura_id) REFERENCES FACTURA(id_factura)
);

CREATE TABLE PAGOS_COMPRAS (
  pago_id          NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  compra_id        NUMBER NOT NULL,
  monto_pagado     NUMBER(14,2) NOT NULL,
  fecha_pago       DATE DEFAULT SYSDATE,
  medio_pago       VARCHAR2(50),
  referencia       VARCHAR2(100),
  CONSTRAINT fk_pc_compra FOREIGN KEY (compra_id) REFERENCES COMPRA(id_compra)
);

-- =============================
-- MENU
-- =============================

CREATE TABLE MENU_SISTEMA (
  menu_id         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre_opcion   VARCHAR2(100) NOT NULL,
  url_aplicacion  VARCHAR2(200),
  menu_padre_id   NUMBER,
  icono           VARCHAR2(50),
  orden           NUMBER DEFAULT 1,
  CONSTRAINT fk_menu_padre FOREIGN KEY (menu_padre_id) REFERENCES MENU_SISTEMA(menu_id)
);

CREATE TABLE PERMISOS_MENU (
  rol_app_id      NUMBER NOT NULL,
  menu_id         NUMBER NOT NULL,
  permiso_leer    NUMBER(1) DEFAULT 0 CHECK (permiso_leer IN (0,1)),
  CONSTRAINT pk_permisos_menu PRIMARY KEY (rol_app_id, menu_id),
  CONSTRAINT fk_permiso_rol FOREIGN KEY (rol_app_id) REFERENCES ROLES_APLICACION(rol_app_id),
  CONSTRAINT fk_permiso_menu FOREIGN KEY (menu_id) REFERENCES MENU_SISTEMA(menu_id)
);

-- Inserta las opciones del menú
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (1, 'Administración', '#', NULL, 'fa-cog', 100);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (2, 'Gestión de Usuarios', '/admin/usuarios', 1, 'fa-users', 1);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (3, 'Ventas', '#', NULL, 'fa-dollar-sign', 10);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (4, 'Nueva Venta', '/ventas/nueva', 3, 'fa-plus', 1);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (5, 'Clientes', '/ventas/clientes', 3, 'fa-user-friends', 2);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (6, 'Inventario', '#', NULL, 'fa-boxes', 20);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (7, 'Revisar Stock', '/inventario/stock', 6, 'fa-search', 1);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (8, 'Registrar Compra', '/inventario/compras', 6, 'fa-truck', 2);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (9, 'Productos', '/inventario/productos', 6, 'fa-cube', 3);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (10, 'Contabilidad', '#', NULL, 'fa-file-invoice-dollar', 30);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (11, 'Cuentas por Cobrar', '/conta/cxc', 10, 'fa-arrow-down', 1);
INSERT INTO MENU_SISTEMA (menu_id, nombre_opcion, url_aplicacion, menu_padre_id, icono, orden) VALUES (12, 'Cuentas por Pagar', '/conta/cxp', 10, 'fa-arrow-up', 2);

-- Asigna permisos a los roles
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 1, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 2, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 3, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 4, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 5, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 6, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 7, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 8, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 9, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 10, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 11, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (1, 12, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (2, 3, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (2, 4, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (2, 5, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (3, 6, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (3, 7, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (3, 8, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (3, 9, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (4, 10, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (4, 11, 1);
INSERT INTO PERMISOS_MENU (rol_app_id, menu_id, permiso_leer) VALUES (4, 12, 1);

-- =============================
-- DATOS MAESTROS INICIALES
-- =============================
INSERT INTO FORMA_PAGO (tipo) VALUES ('Efectivo');
INSERT INTO FORMA_PAGO (tipo) VALUES ('Tarjeta');
INSERT INTO FORMA_PAGO (tipo) VALUES ('Transferencia');
INSERT INTO FORMA_PAGO (tipo) VALUES ('Cheque');

INSERT INTO ROLES_APLICACION (nombre_rol, descripcion) VALUES ('ADMIN', 'Administrador total del sistema');
INSERT INTO ROLES_APLICACION (nombre_rol, descripcion) VALUES ('VENDEDOR', 'Usuario que realiza ventas');
INSERT INTO ROLES_APLICACION (nombre_rol, descripcion) VALUES ('BODEGUERO', 'Encargado de inventario/almacen');
INSERT INTO ROLES_APLICACION (nombre_rol, descripcion) VALUES ('CONTADOR', 'Usuario contabilidad/tesoreria');

COMMIT;
/

-- =============================
-- TRIGGERS CORREGIDOS (VERSIÓN HÍBRIDA)
-- =============================

-- (A) Trigger Venta (CORREGIDO PARA AUDITORÍA DE BD)
CREATE OR REPLACE TRIGGER trg_fd_after_insert
AFTER INSERT ON FACTURA_DETALLE
FOR EACH ROW
DECLARE
  v_usuario_id USUARIO.id_usuario%TYPE;
BEGIN
  -- Lógica de auditoría
  BEGIN
    SELECT id_usuario INTO v_usuario_id FROM USUARIO WHERE username = USER;
  EXCEPTION WHEN NO_DATA_FOUND THEN v_usuario_id := NULL;
  END;

  -- Lógica de stock (esta sigue igual)
  MERGE INTO EXISTENCIAS_SUCURSAL es
  USING (SELECT :NEW.producto_id pid, :NEW.sucursal_origen_id sid FROM dual) src
  ON (es.producto_id = src.pid AND es.sucursal_id = src.sid)
  WHEN MATCHED THEN
    UPDATE SET es.cantidad_stock = NVL(es.cantidad_stock, 0) - :NEW.cantidad
  WHEN NOT MATCHED THEN
    INSERT (producto_id, sucursal_id, cantidad_stock)
    VALUES (:NEW.producto_id, :NEW.sucursal_origen_id, -(:NEW.cantidad));

  INSERT INTO AUDITORIA_GENERAL(usuario_id, accion, tabla_afectada, pk_afectada, detalle)
  VALUES(v_usuario_id, 'UPDATE', 'EXISTENCIAS_SUCURSAL',
         'P:'||:NEW.producto_id||';S:'||:NEW.sucursal_origen_id,
         'Disminuye stock por venta. Cantidad: '||:NEW.cantidad);
END;
/

-- (B) Trigger Compra (CORREGIDO PARA AUDITORÍA DE BD)
CREATE OR REPLACE TRIGGER trg_cd_after_insert
AFTER INSERT ON COMPRA_DETALLE
FOR EACH ROW
DECLARE
  v_usuario_id USUARIO.id_usuario%TYPE;
BEGIN
  BEGIN
    SELECT id_usuario INTO v_usuario_id FROM USUARIO WHERE username = USER;
  EXCEPTION WHEN NO_DATA_FOUND THEN v_usuario_id := NULL;
  END;

  MERGE INTO EXISTENCIAS_SUCURSAL es
  USING (SELECT :NEW.producto_id pid, :NEW.sucursal_destino_id sid FROM dual) src
  ON (es.producto_id = src.pid AND es.sucursal_id = src.sid)
  WHEN MATCHED THEN
    UPDATE SET es.cantidad_stock = NVL(es.cantidad_stock,0) + :NEW.cantidad
  WHEN NOT MATCHED THEN
    INSERT (producto_id, sucursal_id, cantidad_stock)
    VALUES (:NEW.producto_id, :NEW.sucursal_destino_id, :NEW.cantidad);

  INSERT INTO AUDITORIA_GENERAL(usuario_id, accion, tabla_afectada, pk_afectada, detalle)
  VALUES(v_usuario_id,'UPDATE','EXISTENCIAS_SUCURSAL',
         'P:'||:NEW.producto_id||';S:'||:NEW.sucursal_destino_id,
         'Aumenta stock por compra. Cantidad: '||:NEW.cantidad);
END;
/

-- (C) Trigger Nota de Crédito (CORREGIDO PARA AUDITORÍA DE BD)
CREATE OR REPLACE TRIGGER trg_ncd_after_insert
AFTER INSERT ON NOTA_CREDITO_DETALLE
FOR EACH ROW
DECLARE
  v_usuario_id USUARIO.id_usuario%TYPE;
BEGIN
  BEGIN
    SELECT id_usuario INTO v_usuario_id FROM USUARIO WHERE username = USER;
  EXCEPTION WHEN NO_DATA_FOUND THEN v_usuario_id := NULL;
  END;

  MERGE INTO EXISTENCIAS_SUCURSAL es
  USING (SELECT :NEW.producto_id pid, :NEW.sucursal_devolucion_id sid FROM dual) src
  ON (es.producto_id = src.pid AND es.sucursal_id = src.sid)
  WHEN MATCHED THEN
    UPDATE SET es.cantidad_stock = NVL(es.cantidad_stock,0) + :NEW.cantidad_devuelta
  WHEN NOT MATCHED THEN
    INSERT (producto_id, sucursal_id, cantidad_stock)
    VALUES (:NEW.producto_id, :NEW.sucursal_devolucion_id, :NEW.cantidad_devuelta);

  INSERT INTO AUDITORIA_GENERAL(usuario_id, accion, tabla_afectada, pk_afectada, detalle)
  VALUES(v_usuario_id,'UPDATE','EXISTENCIAS_SUCURSAL',
         'P:'||:NEW.producto_id||';S:'||:NEW.sucursal_devolucion_id,
         'Aumenta stock por nota de crédito. Cantidad: '||:NEW.cantidad_devuelta);
END;
/

-- (D) Trigger Pago Venta (CORREGIDO PARA AUDITORÍA DE BD)
CREATE OR REPLACE TRIGGER trg_pv_after_insert
AFTER INSERT ON PAGOS_VENTAS
FOR EACH ROW
DECLARE
  v_usuario_id USUARIO.id_usuario%TYPE;
BEGIN
  BEGIN
    SELECT id_usuario INTO v_usuario_id FROM USUARIO WHERE username = USER;
  EXCEPTION WHEN NO_DATA_FOUND THEN v_usuario_id := NULL;
  END;

  UPDATE FACTURA
  SET saldo_pendiente = NVL(saldo_pendiente,0) - :NEW.monto_pagado
  WHERE id_factura = :NEW.factura_id;

  UPDATE FACTURA
  SET estado = CASE
    WHEN NVL(saldo_pendiente,0) <= 0 THEN 'Pagada'
    WHEN NVL(saldo_pendiente,0) < total THEN 'Parcial'
    ELSE estado
  END
  WHERE id_factura = :NEW.factura_id;

  INSERT INTO AUDITORIA_GENERAL(usuario_id, accion, tabla_afectada, pk_afectada, detalle)
  VALUES(v_usuario_id,'UPDATE','FACTURA','F:'||:NEW.factura_id,'Pago registrado: '||:NEW.monto_pagado);
END;
/

-- (E) Trigger Pago Compra (CORREGIDO PARA AUDITORÍA DE BD)
CREATE OR REPLACE TRIGGER trg_pc_after_insert
AFTER INSERT ON PAGOS_COMPRAS
FOR EACH ROW
DECLARE
  v_usuario_id USUARIO.id_usuario%TYPE;
BEGIN
  BEGIN
    SELECT id_usuario INTO v_usuario_id FROM USUARIO WHERE username = USER;
  EXCEPTION WHEN NO_DATA_FOUND THEN v_usuario_id := NULL;
  END;

  UPDATE COMPRA
  SET saldo_pendiente = NVL(saldo_pendiente,0) - :NEW.monto_pagado
  WHERE id_compra = :NEW.compra_id;

  UPDATE COMPRA
  SET estado = CASE
    WHEN NVL(saldo_pendiente,0) <= 0 THEN 'Pagada'
    WHEN NVL(saldo_pendiente,0) < total THEN 'Parcial'
    ELSE estado
  END
  WHERE id_compra = :NEW.compra_id;

  INSERT INTO AUDITORIA_GENERAL(usuario_id, accion, tabla_afectada, pk_afectada, detalle)
  VALUES(v_usuario_id,'UPDATE','COMPRA','C:'||:NEW.compra_id,'Pago compra registrado: '||:NEW.monto_pagado);
END;
/

-- (F) Trigger Auditoría Factura (CORREGIDO PARA AUDITORÍA DE BD)
CREATE OR REPLACE TRIGGER trg_auditoria_factura
AFTER INSERT OR UPDATE OR DELETE ON FACTURA
FOR EACH ROW
DECLARE
  v_old CLOB;
  v_new CLOB;
  v_usuario_id USUARIO.id_usuario%TYPE;
BEGIN
  BEGIN
    SELECT id_usuario INTO v_usuario_id FROM USUARIO WHERE username = USER;
  EXCEPTION WHEN NO_DATA_FOUND THEN v_usuario_id := NULL;
  END;
  
  IF INSERTING THEN
    v_old := NULL;
    v_new := 'NUM:'||:NEW.numero_factura||',TOTAL:'||TO_CHAR(:NEW.total);
    INSERT INTO AUDITORIA_GENERAL(usuario_id, accion, tabla_afectada, pk_afectada, datos_viejos, datos_nuevos, detalle)
    VALUES(v_usuario_id,'INSERT','FACTURA','F:'||:NEW.id_factura,NULL, v_new, 'Insert factura');
  ELSIF UPDATING THEN
    v_old := 'NUM:'||:OLD.numero_factura||',TOTAL:'||TO_CHAR(:OLD.total);
    v_new := 'NUM:'||:NEW.numero_factura||',TOTAL:'||TO_CHAR(:NEW.total);
    INSERT INTO AUDITORIA_GENERAL(usuario_id, accion, tabla_afectada, pk_afectada, datos_viejos, datos_nuevos, detalle)
    VALUES(v_usuario_id,'UPDATE','FACTURA','F:'||:NEW.id_factura, v_old, v_new, 'Update factura');
  ELSIF DELETING THEN
    v_old := 'NUM:'||:OLD.numero_factura||',TOTAL:'||TO_CHAR(:OLD.total);
    INSERT INTO AUDITORIA_GENERAL(usuario_id, accion, tabla_afectada, pk_afectada, datos_viejos, datos_nuevos, detalle)
    VALUES(v_usuario_id,'DELETE','FACTURA','F:'||:OLD.id_factura, v_old, NULL, 'Delete factura');
  END IF;
END;
/

COMMIT;
/


-- (Esta es la versión corregida)
CREATE TABLE USUARIO (
  id_usuario       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre           VARCHAR2(120) NOT NULL,
  username         VARCHAR2(80) UNIQUE NOT NULL,
  password_hash    VARCHAR2(300), -- <<<--- ¡CORREGIDO! Ya no es NOT NULL
  activo           CHAR(1) DEFAULT 'S' CHECK (activo IN ('S','N')),
  rol_app_id       NUMBER, 
  last_login       TIMESTAMP,
  CONSTRAINT fk_usuario_rol FOREIGN KEY (rol_app_id) REFERENCES ROLES_APLICACION(rol_app_id)
);
-- (Conectado como FERRETERIA)
-- Borramos los usuarios de BD, ya no los necesitamos

-- Comprueba que se creó
SELECT * FROM USUARIO WHERE username = 'APP_ADMIN';

-- Comprueba que se creó
SELECT * FROM USUARIO WHERE username = 'ADMIN_SISTEMA';

-- Comprueba que se creó en la tabla USUARIO
select * from Cliente;

GRANT UPDATE ON USUARIO TO SYS;
